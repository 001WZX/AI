<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>å°æ–°AI Â· ç¤¾åŒºæœ‹å‹åœˆç‰ˆ</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial}
body{display:flex;flex-direction:column;height:100vh;background:#f5f7fa}

.scroll-bar {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 20px;
  background: #fff3cd;
  color: #856404;
  font-size: 12px;
  line-height: 20px;
  overflow: hidden;
  white-space: nowrap;
}
.scroll-bar span {
  display: inline-block;
  animation: scroll 15s linear infinite;
  padding-left: 100%;
}
@keyframes scroll {
  from { transform: translateX(0); }
  to { transform: translateX(-100%); }
}

.top{height:70px;background:#fff;border-bottom:1px solid #ddd;display:flex;align-items:center;padding:0 15px;gap:12px;position:relative;padding-top:20px}
.user-info{font-weight:bold;color:#333}
.tab-row{display:flex;gap:8px;margin-left:auto}
.tab{padding:6px 12px;border:1px solid #ddd;border-radius:6px;cursor:pointer;background:#fff}
.tab.active{background:#0078d4;color:#fff;border-color:#0078d4}

.main{flex:1;display:flex;overflow:hidden}
.sidebar{width:260px;background:#fff;border-right:1px solid #ddd;padding:15px;overflow-y:auto}
.right-area{flex:1;display:flex;flex-direction:column;padding:0;overflow:hidden}

.btn{padding:8px 12px;border:none;border-radius:6px;background:#0078d4;color:#fff;cursor:pointer}
.btn:disabled{background:#999;cursor:not-allowed}
.btn-back{background:#555;margin-bottom:10px}
.del-btn{background:#ff4444;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:12px}
.like-btn{padding:6px 12px;background:#0078d4;color:#fff;border:none;border-radius:6px;margin-top:10px}
.like-btn:disabled{background:#999;cursor:not-allowed}
.use-btn{background:#28a745; margin-top: 8px;}
.btn-cancel{background:#999; margin-top: 8px;}

.item{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding:12px;border-radius:8px;background:#eee;margin-bottom:8px;cursor:pointer
}
.item.active{background:#0078d4;color:#fff}
.name{font-weight:bold}

.post-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
.post-card{background:#fff;padding:14px;border-radius:12px;box-shadow:0 2px 8px #00000010;cursor:pointer}
.post-card:hover{box-shadow:0 4px 12px #00000020}
.post-meta{font-size:12px;color:#999;margin:6px 0}
.post-stats{display:flex;gap:10px;font-size:12px;color:#666;margin-top:8px}

.detail-card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px #00000010}
.detail-meta{color:#777;margin:10px 0}
.comment-list{margin-top:20px}
.comment-item{padding:8px 10px;background:#f5f7fa;border-radius:6px;margin-top:6px}
.comment-user{font-size:12px;font-weight:bold}
.comment-text{font-size:13px;margin-top:2px}
.comment-input{width:100%;margin-top:10px;padding:8px;border:1px solid #ddd;border-radius:6px}

.chat-container { flex:1; padding:20px; overflow-y:auto; }
.chat-box{ display:flex; flex-direction:column; gap:10px; }
.input-bar-container { padding:10px 20px; background:#fff; border-top:1px solid #eee; }
.input-bar{ display:flex; gap:8px; }
.input-bar input{ flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; }

.msg { max-width:75%; padding:8px 12px; border-radius:12px; word-wrap:break-word; }
.msg.user { align-self:flex-end; background:#0078d4; color:#fff; border-bottom-right-radius:0; }
.msg.ai { align-self:flex-start; background:#eee; color:#333; border-bottom-left-radius:0; }
.ai-name { font-size:11px; color:#666; margin-bottom:2px; }

.lock-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  color: #fff;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal{position:fixed;inset:0;background:#00000080;display:none;align-items:center;justify-content:center}
.modal-box{background:#fff;width:380px;padding:20px;border-radius:12px}
.modal-box input,.modal-box textarea{width:100%;margin-bottom:10px;padding:10px;border:1px solid #ddd;border-radius:8px}

.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;color:#fff;padding:12px 20px;border-radius:8px;display:none;z-index:999}
</style>
</head>

<body>
<div class="lock-overlay" id="lockOverlay">
  <div>AI æ­£åœ¨å›å¤ä¸­ï¼Œè¯·ç¨å€™...</div>
</div>

<div class="top">
  <div class="scroll-bar">
    <span>ã€æ’­æŠ¥ã€‘ç”±äºå¼€å‘è€…æ˜¯å­¦ç”Ÿå…šï¼Œä¹°ä¸èµ·APIï¼Œåªèƒ½ç”¨å…è´¹çš„ï¼Œæ‰€ä»¥APIæœ‰è¯·æ±‚é™åˆ¶ï¼Œæ¯ç§’é’Ÿåªèƒ½è¯·æ±‚5æ¬¡ã€‚</span>
  </div>
  <div class="user-info">ç”¨æˆ·ï¼š<span id="username">-</span></div>
  <div class="tab-row">
    <div class="tab active" onclick="tab('my')">æˆ‘çš„AI</div>
    <div class="tab" onclick="tab('publish')">æˆ‘çš„ä½œå“</div>
    <div class="tab" onclick="tab('community')">ç¤¾åŒºä½œå“</div>
  </div>
</div>

<div class="main">
  <div class="sidebar" id="sidebar"></div>
  <div class="right-area" id="right"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <h3>åˆ›å»ºè§’è‰²</h3>
    <input id="r-name" placeholder="åç§°">
    <textarea id="r-desc" rows="3" placeholder="æè¿°"></textarea>
    <button class="btn" onclick="create()">ä»…è‡ªç”¨</button>
    <button class="btn" onclick="publish()" style="background:#009688;margin-top:6px">å‘å¸ƒåˆ°ç¤¾åŒº</button>
    <button class="btn btn-cancel" onclick="closeCreate()">å–æ¶ˆ</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<script>
// ç›´æ¥ç”¨è®¾å¤‡IDå½“å”¯ä¸€ç”¨æˆ·ID
const deviceId = localStorage.getItem("deviceId") || "u"+Date.now();
localStorage.setItem("deviceId", deviceId);

// ç”¨æˆ·å = ç”¨æˆ· + è®¾å¤‡ID
const username = "ç”¨æˆ·" + deviceId;

let users = JSON.parse(localStorage.getItem("users")) || [];
let market = JSON.parse(localStorage.getItem("market")) || [];
let hidden = JSON.parse(localStorage.getItem("hidden")) || [];
let stats = JSON.parse(localStorage.getItem("stats")) || {};
let comments = JSON.parse(localStorage.getItem("comments")) || {};
let liked = JSON.parse(localStorage.getItem("liked")) || {};

let currentUser;
let currentRole;
let currentTab = "my";
let page = 1;
const perPage = 4;

const appid = "84ce592e";
const apiKey = "96ea16b7ea9721989d34f0377fdcf36c";
const apiSecret = "YWQyOTEyOTIyZDQyZDA0YzFiMGQ1MGE0";
const gptUrl = "wss://spark-api.xf-yun.com/v1/x1";
let ws = null;
let isReplying = false;
let currentAiMsgWrapper = null;
let currentAiMsgText = null;

init();
function init(){
  // è‡ªåŠ¨ç”¨è®¾å¤‡IDå½“ç”¨æˆ·ï¼Œä¸ç”¨æ³¨å†Œç™»å½•
  currentUser = users.find(u=>u.deviceId===deviceId);
  if(!currentUser){
    currentUser = {
      deviceId: deviceId,
      username: username,
      roles:[],
      messages:{}
    };
    users.push(currentUser);
    saveAll();
  }

  const hasXiaoXin = currentUser.roles.some(r=>r.id==="system_xiaoxin");
  if(!hasXiaoXin){
    currentUser.roles.unshift({
      id:"system_xiaoxin",
      name:"å°æ–°AIåŠ©æ‰‹",
      desc:"ç”±ç‹å±•é‘«å¼€å‘ï¼ŒåŸºäºç§‘å¤§è®¯é£AIåˆ¶é€ ã€‚",
      isSystem:true
    });
    saveAll();
  }

  currentRole = currentUser.roles[0];
  document.getElementById("username").innerText = currentUser.username;
  tab("my");
}

function lockUI() {
  isReplying = true;
  document.getElementById("lockOverlay").style.display = "flex";
  document.getElementById("sendBtn")?.setAttribute("disabled", "true");
}
function unlockUI() {
  isReplying = false;
  document.getElementById("lockOverlay").style.display = "none";
  document.getElementById("sendBtn")?.removeAttribute("disabled");
}

function checkReplying() {
  if (isReplying) {
    alert("AI æ­£åœ¨å›å¤ä¸­ï¼Œè¯·ç¨å€™å†æ“ä½œï¼");
    return false;
  }
  return true;
}

function tab(t){
  if (!checkReplying()) return;
  currentTab = t;
  document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active"));
  document.querySelectorAll(".tab")[t==="my"?0:t==="publish"?1:2].classList.add("active");

  if(t==="my"){
    document.getElementById("sidebar").innerHTML = `
      <button class="btn" onclick="openCreate()" style="margin-bottom:10px;">+ åˆ›å»ºè§’è‰²</button>
      <div id="roleList"></div>
    `;
    renderMyAI();
  } else {
    document.getElementById("sidebar").innerHTML = "";
    t==="publish" ? renderMyPublish() : renderCommunity();
  }
}

function renderMyAI(){
  const list = document.getElementById("roleList");
  list.innerHTML = "";
  currentUser.roles.forEach(r=>{
    const item = document.createElement("div");
    item.className = "item" + (currentRole?.id===r.id ? " active" : "");
    
    let delBtn = "";
    if(!r.isSystem){
      delBtn = `<button class="del-btn" onclick="deleteRole('${r.id}')">åˆ é™¤</button>`;
    }

    item.innerHTML = `
      <div onclick="selectRole('${r.id}')">
        <div class="name">${r.name}</div>
      </div>
      ${delBtn}
    `;
    list.appendChild(item);
  });

  document.getElementById("right").innerHTML = `
    <div class="chat-container">
      <div class="chat-box" id="chat-box"></div>
    </div>
    <div class="input-bar-container">
      <div class="input-bar">
        <input id="msg" placeholder="è¾“å…¥æ¶ˆæ¯" onkeydown="event.key==='Enter'&&send()">
        <button class="btn" id="sendBtn" onclick="send()">å‘é€</button>
      </div>
    </div>
  `;
  renderChat();
  scrollToBottom();
}

function selectRole(id){
  if (!checkReplying()) return;
  currentRole = currentUser.roles.find(r=>r.id===id);
  renderMyAI();
  scrollToBottom();
}

function deleteRole(id){
  if (!checkReplying()) return;
  if(id==="system_xiaoxin") return;
  currentUser.roles = currentUser.roles.filter(r=>r.id!==id);
  if(currentRole?.id===id) currentRole = currentUser.roles[0];
  saveAll();
  renderMyAI();
  toast("å·²åˆ é™¤");
}

function renderMyPublish(){
  const my = market.filter(p=>p.authorId===deviceId && !hidden.includes(p.id));
  document.getElementById("right").innerHTML = my.length ? my.map(p=>`
    <div style="background:#fff; padding:16px; margin:20px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
      <div class="name">${p.name}</div>
      <button class="del-btn" onclick="delPublish('${p.id}')">åˆ é™¤å‘å¸ƒ</button>
    </div>
  `).join("") : "<div style='padding:20px'>æš‚æ— å‘å¸ƒ</div>";
}

function renderCommunity(){
  let list = market.filter(p=>!hidden.includes(p.id)).sort((a,b)=>(stats[b.id]?.like||0)-(stats[a.id]?.like||0));
  const total = Math.ceil(list.length/perPage);
  list = list.slice((page-1)*perPage, page*perPage);

  document.getElementById("right").innerHTML = `
    <div style="padding:20px">æœ‹å‹åœˆï¼ˆä¸€é¡µ4ä¸ªï¼‰</div>
    <div class="post-grid" style="padding:0 20px">
      ${list.map(p=>{
        const s=stats[p.id]||{like:0,comment:0};
        return `
        <div class="post-card" onclick="openDetail('${p.id}')">
          <div class="name">${p.name}</div>
          <div class="post-meta">ä½œè€…ï¼š${p.author}</div>
          <div class="desc">${p.desc}</div>
          <div class="post-stats">
            <span>ğŸ‘ ${s.like}</span>
            <span>è¯„è®º ${s.comment}</span>
          </div>
          <button class="btn use-btn" onclick="event.stopPropagation();useFromCommunity('${p.id}')">ä½¿ç”¨è¯¥AI</button>
        </div>`;
      }).join("")}
    </div>
    <div style="text-align:center;margin:12px 0">
      <button class="btn" style="background:#555" onclick="${page>1?(page--,renderCommunity()):''}">ä¸Šä¸€é¡µ</button>
      <span>${page}/${total}</span>
      <button class="btn" style="background:#555" onclick="${page<total?(page++,renderCommunity()):''}">ä¸‹ä¸€é¡µ</button>
    </div>
  `;
}

function openDetail(postId){
  const p = market.find(x=>x.id===postId);
  if(!p) return;
  const s = stats[postId] || {like:0, comment:0};
  const cmts = comments[postId] || [];
  const isLiked = (liked[deviceId]||[]).includes(postId);

  document.getElementById("right").innerHTML = `
    <div style="padding:20px">
      <button class="btn btn-back" onclick="renderCommunity()">â† è¿”å›ç¤¾åŒº</button>
      <div class="detail-card">
        <h3>${p.name}</h3>
        <div class="detail-meta">ä½œè€…ï¼š${p.author}</div>
        <div style="margin:10px 0">${p.desc}</div>
        <button class="like-btn" ${isLiked?"disabled":""} onclick="likePost('${postId}')">
          ${isLiked?"å·²ç‚¹èµ":"ğŸ‘ ç‚¹èµ"}
        </button>
        <div class="post-stats" style="margin-top:8px">
          <span>ç‚¹èµï¼š${s.like}</span>
          <span>è¯„è®ºï¼š${s.comment}</span>
        </div>

        <div class="comment-list">
          ${cmts.map(c=>`
            <div class="comment-item">
              <div class="comment-user">${c.user}</div>
              <div class="comment-text">${c.text}</div>
            </div>
          `).join("")}
        </div>

        <input class="comment-input" id="commentInput" placeholder="å†™è¯„è®º...">
        <button class="btn" style="margin-top:8px" onclick="sendComment('${postId}')">å‘å¸ƒè¯„è®º</button>
      </div>
    </div>
  `;
}

function likePost(postId){
  if(!stats[postId]) stats[postId]={like:0,comment:0};
  if(!liked[deviceId]) liked[deviceId]=[];
  if(liked[deviceId].includes(postId)) return;
  liked[deviceId].push(postId);
  stats[postId].like++;
  saveAll();
  openDetail(postId);
}

function sendComment(postId){
  const txt = document.getElementById("commentInput").value.trim();
  if(!txt) return;
  if(!comments[postId]) comments[postId]=[];
  comments[postId].push({user:currentUser.username, text:txt});
  if(!stats[postId]) stats[postId]={like:0,comment:0};
  stats[postId].comment++;
  saveAll();
  openDetail(postId);
}

function useFromCommunity(id){
  if (!checkReplying()) return;
  const p = market.find(x=>x.id===id);
  if(!p) return;
  if(currentUser.roles.some(r=>r.name===p.name)) return toast("å·²æ·»åŠ ");
  currentUser.roles.push({id:"c"+Date.now(), name:p.name, desc:p.desc});
  saveAll();
  toast("å·²æ·»åŠ åˆ°æˆ‘çš„AI");
  tab("my");
}

function createWsUrl() {
  const urlObj = new URL(gptUrl);
  const date = new Date().toUTCString();
  const signature = CryptoJS.enc.Base64.stringify(
    CryptoJS.HmacSHA256(
      `host: ${urlObj.host}\ndate: ${date}\nGET ${urlObj.pathname} HTTP/1.1`,
      apiSecret
    )
  );
  const authorization = btoa(
    `api_key="${apiKey}", algorithm="hmac-sha256", headers="host date request-line", signature="${signature}"`
  );
  return `${gptUrl}?authorization=${authorization}&date=${date}&host=${urlObj.host}`;
}

function updateAiMsg(text) {
  if (!currentAiMsgWrapper) {
    currentAiMsgWrapper = document.createElement("div");
    currentAiMsgWrapper.style.alignSelf = "flex-start";
    
    const nameTag = document.createElement("div");
    nameTag.className = "ai-name";
    nameTag.textContent = currentRole.name;
    
    currentAiMsgText = document.createElement("div");
    currentAiMsgText.className = "msg ai";
    currentAiMsgText.textContent = text;
    
    currentAiMsgWrapper.appendChild(nameTag);
    currentAiMsgWrapper.appendChild(currentAiMsgText);
    document.getElementById("chat-box").appendChild(currentAiMsgWrapper);
  } else {
    currentAiMsgText.textContent += text;
  }
  scrollToBottom();
}

function send(){
  if(!checkReplying() || !currentRole) return;
  const txt = document.getElementById("msg").value.trim();
  if(!txt) return;

  const ms = currentUser.messages[currentRole.id] || (currentUser.messages[currentRole.id] = []);
  ms.push({sender:"user", text:txt});
  renderChat();
  document.getElementById("msg").value = "";
  
  currentAiMsgWrapper = null;
  currentAiMsgText = null;
  lockUI();

  if (ws) ws.close();
  ws = new WebSocket(createWsUrl());

  ws.onopen = () => {
    const msgList = [
      { role:"system", content:`ä½ æ˜¯${currentRole.name}ï¼Œ${currentRole.desc}ï¼Œè¯·è‡ªç„¶å¯¹è¯ï¼Œè®°ä½ä¸Šä¸‹æ–‡ã€‚` }
    ];
    ms.forEach(m => {
      msgList.push({
        role: m.sender === "user" ? "user" : "assistant",
        content: m.text
      });
    });

    ws.send(JSON.stringify({
      header: { app_id: appid, uid: deviceId },
      parameter: { chat: { max_tokens: 32768, domain: "x1", top_k: 6, temperature: 1.2 } },
      payload: { message: { text: msgList } }
    }));
  };

  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.header.code !== 0) {
      updateAiMsg(`é”™è¯¯ï¼š${data.header.message || "è¯·æ±‚å¤±è´¥"}`);
      ws.close();
      return;
    }
    const content = data.payload?.choices?.text?.[0]?.content || '';
    if (content) updateAiMsg(content);
    if (data.payload?.choices?.status === 2) {
      if (currentAiMsgText) {
        ms.push({sender:"ai", text: currentAiMsgText.textContent});
        saveAll();
      }
      ws.close();
    }
  };

  ws.onerror = () => {
    updateAiMsg("APIè¯·æ±‚å¤±è´¥");
    ws.close();
  };

  ws.onclose = () => {
    unlockUI();
  };
}

function renderChat(){
  const box = document.getElementById("chat-box");
  const ms = currentUser.messages[currentRole.id] || [];
  box.innerHTML = ms.map(x=>x.sender==="user"
    ? `<div class="msg user">${x.text}</div>`
    : `<div style="align-self:flex-start">
        <div class="ai-name">${currentRole.name}</div>
        <div class="msg ai">${x.text}</div>
      </div>`
  ).join("");
  scrollToBottom();
}

function scrollToBottom() {
  const b = document.getElementById("chat-box");
  if(b) b.scrollTop = b.scrollHeight;
}

function openCreate(){ if (!checkReplying()) return; document.getElementById("modal").style.display="flex" }
function closeCreate(){ document.getElementById("modal").style.display="none" }
function create(){ doCreate(false) }
function publish(){ doCreate(true) }

function doCreate(pub){
  const n = document.getElementById("r-name").value.trim();
  const d = document.getElementById("r-desc").value.trim();
  if(!n||!d) return toast("è¯·å¡«å†™å®Œæ•´");
  
  const exist = currentUser.roles.some(r=>r.name === n);
  if(exist){
    toast("è¯¥åç§°å·²å­˜åœ¨ï¼");
    return;
  }

  const id = "c"+Date.now();
  currentUser.roles.push({id,name:n,desc:d});
  if(pub){
    market.push({
      id,name:n,desc:d,
      author:currentUser.username,
      authorId:deviceId
    });
    stats[id]={like:0,comment:0};
  }
  saveAll();
  document.getElementById("modal").style.display="none";
  tab("my");
  toast(pub?"å‘å¸ƒæˆåŠŸ":"åˆ›å»ºæˆåŠŸ");
}

function delPublish(id){ 
  if (!checkReplying()) return;
  hidden.push(id); 
  saveAll(); 
  renderMyPublish(); 
  toast("å·²åˆ é™¤"); 
}

function saveAll(){
  localStorage.setItem("users",JSON.stringify(users));
  localStorage.setItem("market",JSON.stringify(market));
  localStorage.setItem("hidden",JSON.stringify(hidden));
  localStorage.setItem("stats",JSON.stringify(stats));
  localStorage.setItem("comments",JSON.stringify(comments));
  localStorage.setItem("liked",JSON.stringify(liked));
}

function toast(m){
  const t=document.getElementById("toast");
  t.innerText=m;
  t.style.display="block";
  setTimeout(()=>t.style.display="none",1400);
}
</script>
</body>
</html>
